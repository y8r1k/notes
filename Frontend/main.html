<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Заметки</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 30px auto; padding: 0 15px; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
    button { padding: 6px 12px; margin: 5px 0; cursor: pointer; }
    .note { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .actions { margin-top: 5px; }
    .error { background: #ffe5e5; padding: 10px; color: #900; }
    .timestamps { font-size: 0.85em; color: #555; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Заметки</h1>

  <div id="error" class="error" style="display:none;"></div>

  <form id="noteForm">
    <input type="text" id="title" placeholder="Заголовок" required />
    <textarea id="description" placeholder="Описание" required></textarea>
    <button type="submit" id="submitBtn">Создать</button>
  </form>

  <div id="notes"></div>

  <script>
    const API = 'http://localhost:8080/notes';

    const form = document.getElementById('noteForm');
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const notesDiv = document.getElementById('notes');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    let editingId = null;

    async function fetchNotes() {
      try {
        const res = await fetch(API);
        const data = await res.json();
        renderNotes(data);
      } catch {
        showError('Ошибка загрузки заметок');
      }
    }

    function renderNotes(notes) {
      notesDiv.innerHTML = '';
      notes.forEach(note => {
        const div = document.createElement('div');
        div.className = 'note';
        const created = new Date(note.created).toLocaleString();
        const changed = note.changed ? new Date(note.changed).toLocaleString() : '';
        div.innerHTML = `
          <strong>${note.title}</strong>
          <p>${note.description}</p>
          <div class="timestamps">
            Создано: ${created}${changed ? ' | Изменено: ' + changed : ''}
          </div>
          <div class="actions">
            <button onclick="editNote(${note.id}, '${escapeQuotes(note.title)}', '${escapeQuotes(note.description)}')">Редактировать</button>
            <button onclick="deleteNote(${note.id})">Удалить</button>
          </div>
        `;
        notesDiv.appendChild(div);
      });
    }

    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    async function createNote(note) {
      await fetch(`${API}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(note)
      });
    }

    async function updateNote(id, note) {
      await fetch(`${API}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(note)
      });
    }

    async function deleteNote(id) {
      try {
        await fetch(`${API}/${id}`, { method: 'DELETE' });
        fetchNotes();
      } catch {
        showError('Ошибка удаления');
      }
    }

    function editNote(id, title, description) {
      editingId = id;
      titleInput.value = title;
      descriptionInput.value = description;
      submitBtn.textContent = 'Сохранить';
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 3000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const note = {
        title: titleInput.value.trim(),
        description: descriptionInput.value.trim()
      };
      if (!note.title || !note.description) return;

      try {
        if (editingId) {
          await updateNote(editingId, note);
          editingId = null;
          submitBtn.textContent = 'Создать';
        } else {
          await createNote(note);
        }
        titleInput.value = '';
        descriptionInput.value = '';
        fetchNotes();
      } catch {
        showError('Ошибка сохранения');
      }
    });

    fetchNotes();
  </script>
</body>
</html>
